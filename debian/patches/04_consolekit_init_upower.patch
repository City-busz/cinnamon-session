From e7cbff3fb381c6d1666d148889a5e485d5e2e418 Mon Sep 17 00:00:00 2001
From: Martin Pitt <martinpitt@gnome.org>
Date: Tue, 13 Nov 2012 11:02:35 +0100
Subject: [PATCH] GsmConsoleKit: Properly initialize upower client

Move UPower client initialization from gsm_consolekit_on_name_owner_changed()
(which is not actually called for UPower usually) into
gsm_consolekit_ensure_ck_connection().

This makes the UPower calls actually work, otherwise they fail on trying to
pass a NULL client.

Bug: https://bugzilla.gnome.org/show_bug.cgi?id=688229
Bug-Ubuntu: https://launchpad.net/bugs/1041137
---
 gnome-session/gsm-consolekit.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

Index: gnome-session/gnome-session/gsm-consolekit.c
===================================================================
--- gnome-session.orig/gnome-session/gsm-consolekit.c	2012-11-13 00:32:21.000000000 +0100
+++ gnome-session/gnome-session/gsm-consolekit.c	2012-11-13 11:20:34.467418247 +0100
@@ -182,6 +182,9 @@
                 }
         }
 
+        g_clear_object (&manager->priv->up_client);
+        manager->priv->up_client = up_client_new ();
+
         is_connected = TRUE;
 
  out:
@@ -219,10 +222,8 @@
         }
 
         g_clear_object (&manager->priv->ck_proxy);
-        g_clear_object (&manager->priv->up_client);
 
         gsm_consolekit_ensure_ck_connection (manager, NULL);
-        manager->priv->up_client = up_client_new ();
 
 }
 
